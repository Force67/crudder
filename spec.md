# Crudder DTL Type Specification

This document specifies all supported types in the Crudder Domain-Specific Language (DTL).

## Primitive Types

The DTL supports 8 primitive types:

| Type        | Rust Equivalent  | TypeScript Equivalent | SQL Equivalent       |
|-------------|------------------|----------------------|----------------------|
| `string`    | `String`         | `string`             | `TEXT`               |
| `int`       | `i64`            | `number`             | `BIGINT`             |
| `float`     | `f64`            | `number`             | `DOUBLE PRECISION`   |
| `bool`      | `bool`           | `boolean`            | `BOOLEAN`            |
| `uuid`      | `Uuid`           | `string`             | `UUID`               |
| `cuid2`     | `String`         | `string`             | `TEXT`               |
| `timestamp` | `DateTime<Utc>`  | `Date`               | `TIMESTAMPTZ`        |
| `bytes`     | `Vec<u8>`        | `Uint8Array`         | `BYTEA`              |

## Type Modifiers

Types can be modified with the following constructs:

### Optional Types

Suffix a type with `?` to make it optional:

```
string?
int?
User?
```

### Array Types

Prefix a type with `[]` to create an array:

```
[]string
[]int
[]User
```

### Named Types

Reference custom DTOs by name:

```
User
Address
OrderItem
```

### Combined Modifiers

Modifiers can be combined:

```
[]string?      # optional array of strings
[]User?        # optional array of User objects
[][]int        # nested array of integers
```

## Usage in DTOs

Types are used to define fields in Data Transfer Objects:

```crudder
dto User {
    @primary @auto
    id: uuid

    name: string
    email: string?
    age: int
    active: bool
    created_at: timestamp
    tags: []string
    avatar: bytes?
}
```

## Usage in Services

Types define method parameters and return values:

```crudder
service UserService {
    get_user(id: uuid): User?
    list_users(): []User
    create_user(name: string, email: string?): User
}
```

---

# Postgres Support

Crudder provides comprehensive Postgres support through the SQLx code generator.

## Storage Targets

Generate a Postgres backend using the CLI:

```bash
crudder generate schema.crudder --target sqlx-postgres --output ./generated

# Alternative target names
crudder generate schema.crudder --target postgres --output ./generated
crudder generate schema.crudder --target pg --output ./generated
```

## Entity Annotations

### @table

Marks a DTO as a database entity and specifies the table name:

```crudder
@table("users")
dto User {
    @primary @auto id: uuid
    name: string
}
```

### @primary

Marks a field as the primary key:

```crudder
@primary
id: uuid
```

### @auto

Marks a field as auto-generated by the database:

- `uuid` fields get `DEFAULT gen_random_uuid()`
- `timestamp` fields get `DEFAULT NOW()`

```crudder
@primary @auto id: uuid
@auto createdAt: timestamp
```

### @column

Specifies a custom SQL column name:

```crudder
@column("user_id")
userId: uuid
```

### @references

Creates a foreign key relationship to another entity:

```crudder
@references(User)
userId: uuid
```

Generates: `FOREIGN KEY (user_id) REFERENCES users(id)`

## Service Annotations

### @storage

Specifies the storage backend for a service:

```crudder
@storage("postgres")
service TodoService {
    // ...
}
```

Supported values: `postgres`, `sqlite`, `memory`

### @rest

Configures the HTTP endpoint for a method:

```crudder
@rest("GET", "/todos")
ListTodos(Empty) -> TodoList

@rest("POST", "/todos")
CreateTodo(CreateTodoRequest) -> Todo

@rest("PUT", "/todos/{id}")
UpdateTodo(UpdateTodoRequest) -> Todo

@rest("DELETE", "/todos/{id}")
DeleteTodo(Empty) -> Empty
```

## Authentication Annotations

### @public

No authentication required:

```crudder
@public
@rest("GET", "/todos")
ListTodos(Empty) -> TodoList
```

### @authenticated

Requires a valid auth token:

```crudder
@authenticated
@rest("POST", "/todos")
CreateTodo(CreateTodoRequest) -> Todo
```

### @owner

Requires authentication and verifies the authenticated user owns the resource:

```crudder
@owner("userId")
@rest("PUT", "/todos/{id}")
UpdateTodo(UpdateTodoRequest) -> Todo
```

### @role

Requires authentication and a specific role:

```crudder
@role("admin")
@rest("DELETE", "/users/{id}")
DeleteUser(Empty) -> Empty
```

## SQL Type Mapping

| Crudder Type | Postgres Type      | Notes                          |
|--------------|--------------------|--------------------------------|
| `string`     | `TEXT`             |                                |
| `int`        | `BIGINT`           |                                |
| `float`      | `DOUBLE PRECISION` |                                |
| `bool`       | `BOOLEAN`          | Defaults to `FALSE`            |
| `uuid`       | `UUID`             |                                |
| `cuid2`      | `TEXT`             | Application-generated ID       |
| `timestamp`  | `TIMESTAMPTZ`      | Timezone-aware                 |
| `bytes`      | `BYTEA`            |                                |
| `Type?`      | Same as inner type | `NULL` allowed                 |
| `[]Type`     | `JSONB`            | Stored as JSON                 |
| Named types  | `JSONB`            | Stored as JSON                 |

## Generated SQL Schema

For a DTO like:

```crudder
@table("todos")
dto Todo {
    @primary @auto id: uuid
    title: string
    completed: bool
    @references(User) userId: uuid
    @auto createdAt: timestamp
}
```

Crudder generates:

```sql
CREATE TABLE todos (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    title TEXT NOT NULL,
    completed BOOLEAN DEFAULT FALSE,
    user_id UUID NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    FOREIGN KEY (user_id) REFERENCES users(id)
);
```

## Generated CRUD Operations

The code generator produces parameterized SQL queries:

### Create (INSERT)

```sql
INSERT INTO todos (title, completed, user_id)
VALUES ($1, $2, $3)
RETURNING *
```

### Read (SELECT)

```sql
SELECT * FROM todos WHERE id = $1
```

### List (SELECT ALL)

```sql
SELECT * FROM todos
```

### Update (UPDATE)

```sql
UPDATE todos
SET title = COALESCE($2, title),
    completed = COALESCE($3, completed)
WHERE id = $1
RETURNING *
```

Uses `COALESCE` for partial updates - only provided fields are updated.

### Delete (DELETE)

```sql
DELETE FROM todos WHERE id = $1
```

## Migrations

Crudder automatically generates numbered migration files:

```
migrations/
├── 001_create_users.sql
├── 002_create_todos.sql
└── 003_create_comments.sql
```

Each migration contains the complete `CREATE TABLE` statement for one entity.

## Generated Project Structure

```
output/
├── Cargo.toml
├── src/
│   ├── lib.rs          # Router setup
│   ├── types.rs        # Entity structs with sqlx::FromRow
│   ├── auth.rs         # Authentication module
│   └── {service}.rs    # CRUD handlers
└── migrations/
    └── *.sql           # Schema migrations
```

## Complete Example

```crudder
@table("todos")
dto Todo {
    @primary @auto id: uuid
    title: string
    completed: bool
    @references(User) userId: uuid
    @auto createdAt: timestamp
}

dto CreateTodoRequest {
    title: string
    userId: uuid
}

dto UpdateTodoRequest {
    id: uuid
    title: string?
    completed: bool?
}

dto TodoList {
    items: []Todo
}

@storage("postgres")
service TodoService {
    @public
    @rest("GET", "/todos")
    ListTodos(Empty) -> TodoList

    @authenticated
    @rest("POST", "/todos")
    CreateTodo(CreateTodoRequest) -> Todo

    @owner("userId")
    @rest("PUT", "/todos/{id}")
    UpdateTodo(UpdateTodoRequest) -> Todo

    @owner("userId")
    @rest("DELETE", "/todos/{id}")
    DeleteTodo(Empty) -> Empty
}
```
